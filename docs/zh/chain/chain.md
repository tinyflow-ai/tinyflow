# Chain å¼€å‘è®¾è®¡æ–‡æ¡£



## 1. æ¦‚è¿°

åœ¨ Tinyflow AI å·¥ä½œæµç¼–æ’æ¡†æ¶ä¸­ï¼Œ`Chain` æ˜¯**æ‰§è¡Œå¼•æ“çš„æ ¸å¿ƒæŠ½è±¡**ï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ªå·¥ä½œæµçš„ç”Ÿå‘½å‘¨æœŸã€çŠ¶æ€åè°ƒã€èŠ‚ç‚¹è°ƒåº¦ã€é”™è¯¯å¤„ç†ä¸äº‹ä»¶é€šçŸ¥ã€‚å®ƒå°†é™æ€çš„ `ChainDefinition`ï¼ˆå·¥ä½œæµå®šä¹‰ï¼‰ä¸åŠ¨æ€çš„è¿è¡Œæ—¶çŠ¶æ€ï¼ˆ`ChainState`ï¼‰è§£è€¦ï¼Œå®ç°äº†**å¯æ¢å¤ã€å¯ç›‘æ§ã€å¯å¹¶è¡Œã€å¯æŒä¹…åŒ–**çš„ AI å·¥ä½œæµæ‰§è¡Œæ¨¡å‹ã€‚

æœ¬æ–‡æ¡£æ·±å…¥è§£æ `Chain` çš„**è®¾è®¡å“²å­¦ã€æ¶æ„ç»„æˆã€çŠ¶æ€ç®¡ç†æœºåˆ¶ä¸æ‰©å±•ç‚¹**ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£å…¶å†…éƒ¨è¿ä½œåŸç†ï¼Œå¹¶åŸºäºæ­¤æ„å»ºé«˜å¯é ã€é«˜å¯ç»´æŠ¤çš„ AI åº”ç”¨ã€‚



## 2. è®¾è®¡å“²å­¦

### 2.1 çŠ¶æ€ä¸å®šä¹‰åˆ†ç¦»ï¼ˆState-Definition Separationï¼‰

- **`ChainDefinition`**ï¼šåªè¯»çš„ã€é™æ€çš„å·¥ä½œæµè“å›¾ï¼ŒåŒ…å«èŠ‚ç‚¹ï¼ˆNodeï¼‰ã€è¾¹ï¼ˆEdgeï¼‰ã€æ¡ä»¶ï¼ˆConditionï¼‰ç­‰æ‹“æ‰‘ç»“æ„ã€‚
- **`ChainState`**ï¼šåŠ¨æ€çš„ã€å¯å˜çš„è¿è¡Œæ—¶çŠ¶æ€ï¼Œè®°å½•æ‰§è¡Œè¿›åº¦ã€å†…å­˜å˜é‡ã€é”™è¯¯ä¿¡æ¯ã€æŒ‚èµ·çŠ¶æ€ç­‰ã€‚

> ç‰¹ç‚¹ï¼šåŒä¸€ `ChainDefinition` å¯è¢«å¤šä¸ªå®ä¾‹ï¼ˆ`stateInstanceId`ï¼‰å¹¶è¡Œæ‰§è¡Œï¼Œå½¼æ­¤çŠ¶æ€éš”ç¦»ã€‚

### 2.2 äº‹ä»¶é©±åŠ¨ï¼ˆEvent-Drivenï¼‰

`Chain` é€šè¿‡ `EventManager` å‘å¸ƒç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¦‚ `ChainStartEvent`ã€`NodeEndEvent`ï¼‰ï¼Œæ”¯æŒï¼š
- æ—¥å¿—è®°å½•
- æŒ‡æ ‡ä¸ŠæŠ¥ï¼ˆPrometheusï¼‰
- å¤–éƒ¨ç³»ç»Ÿé€šçŸ¥ï¼ˆWebhookï¼‰
- è‡ªå®šä¹‰ç›‘æ§é€»è¾‘

### 2.3 ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOptimistic Concurrency Controlï¼‰

é‡‡ç”¨**ç‰ˆæœ¬å· + é‡è¯•æœºåˆ¶**ä¿è¯çŠ¶æ€æ›´æ–°çš„åŸå­æ€§ä¸ä¸€è‡´æ€§ï¼Œé¿å…åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç«æ€æ¡ä»¶ã€‚

### 2.4 å¯æ¢å¤æ‰§è¡Œï¼ˆResumable Executionï¼‰

æ”¯æŒ**æŒ‚èµ·ï¼ˆSuspendï¼‰ä¸æ¢å¤ï¼ˆResumeï¼‰**ï¼Œé€‚ç”¨äºéœ€äººå·¥å¹²é¢„ã€å¼‚æ­¥å›è°ƒæˆ–é•¿æ—¶é—´ç­‰å¾…çš„åœºæ™¯ï¼ˆå¦‚å®¡æ‰¹ã€æ”¯ä»˜å›è°ƒï¼‰ã€‚



## 3. æ ¸å¿ƒæ¶æ„

`Chain` çš„æ‰§è¡Œä¾èµ–ä»¥ä¸‹å…³é”®ç»„ä»¶ï¼š

| ç»„ä»¶ | èŒè´£                  | æ‰©å±•æ¥å£ |
|--|---------------------|--|
| `ChainDefinition` | å·¥ä½œæµé™æ€å®šä¹‰ï¼ˆåªè¯»ï¼‰         | `ChainDefinitionRepository` |
| `ChainStateRepository` | æŒä¹…åŒ–/åŠ è½½ `ChainState` | å¯æ›¿æ¢ï¼ˆå¦‚ Redisã€DBï¼‰ |
| `NodeStateRepository` | æŒä¹…åŒ–/åŠ è½½ `NodeState`  | å¯æ›¿æ¢ |
| `TriggerScheduler` | è°ƒåº¦èŠ‚ç‚¹æ‰§è¡Œï¼ˆæ”¯æŒå»¶è¿Ÿã€é‡è¯•ã€å¾ªç¯ï¼‰  | å¯æ›¿æ¢ï¼ˆå¦‚ Quartzã€Redis Streamsï¼‰ |
| `EventManager` | äº‹ä»¶å‘å¸ƒä¸ç›‘å¬             | å¯æ³¨å†Œè‡ªå®šä¹‰ç›‘å¬å™¨ |

> ğŸ“Œ æ‰€æœ‰ç»„ä»¶å‡å¯é€šè¿‡ setter æ³¨å…¥ï¼Œå®ç°**ä¾èµ–æ³¨å…¥å‹å¥½**ä¸**æµ‹è¯•å¯ mock**ã€‚



## 4. çŠ¶æ€ç®¡ç†æœºåˆ¶

### 4.1 çŠ¶æ€æ¨¡å‹

- **`ChainState`**ï¼šé“¾çº§åˆ«çŠ¶æ€
    - `status`ï¼š`RUNNING` / `SUSPEND` / `SUCCEEDED` / `FAILED`
    - `memory`ï¼šå…¨å±€å˜é‡å­˜å‚¨ï¼ˆ`Map<String, Object>`ï¼‰
    - `executeResult`ï¼šæœ€è¿‘ä¸€æ¬¡èŠ‚ç‚¹è¾“å‡º
    - `suspendForParameters`ï¼šæŒ‚èµ·æ—¶éœ€å¤–éƒ¨æä¾›çš„å‚æ•°
    - `suspendNodeIds`ï¼šæŒ‚èµ·çš„èŠ‚ç‚¹ ID é›†åˆ
    - `version`ï¼šç”¨äºä¹è§‚é”çš„ç‰ˆæœ¬å·

- **`NodeState`**ï¼šèŠ‚ç‚¹çº§åˆ«çŠ¶æ€
    - `status`ï¼š`PENDING` / `RUNNING` / `SUCCEEDED` / `ERROR` / `SUSPEND`
    - `executeCount` / `retryCount` / `loopCount`
    - `error`ï¼šå¼‚å¸¸æ‘˜è¦ï¼ˆ`ExceptionSummary`ï¼‰
    - `version`ï¼šéšå¼é€šè¿‡ `ChainState.version` ä¿è¯ä¸€è‡´æ€§

### 4.2 å®‰å…¨çŠ¶æ€æ›´æ–°ï¼š`updateStateSafely`

```java
public ChainState updateStateSafely(ChainStateModifier modifier) {
    // 1. åŠ è½½å½“å‰çŠ¶æ€
    ChainState current = repository.load(instanceId);
    
    // 2. åº”ç”¨ä¿®æ”¹ï¼Œè¿”å›å˜æ›´å­—æ®µ
    EnumSet<ChainStateField> fields = modifier.modify(current);
    
    // 3. å°è¯• CAS æ›´æ–°ï¼ˆåŸºäº versionï¼‰
    if (repository.tryUpdate(current, fields)) {
        return current; // æˆåŠŸ
    }
    
    // 4. å¤±è´¥åˆ™é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ + jitterï¼‰
    // ... æœ€å¤šé‡è¯• 30 ç§’
}
```

- **å­—æ®µçº§æ›´æ–°**ï¼š`modifier` è¿”å› `EnumSet<ChainStateField>`ï¼Œä»…æŒä¹…åŒ–å˜æ›´å­—æ®µï¼Œæå‡æ€§èƒ½ã€‚
- **è¶…æ—¶æ§åˆ¶**ï¼š30 ç§’å†…æ— æ³•æˆåŠŸåˆ™æŠ›å‡º `ChainUpdateTimeoutException`ã€‚
- **é€€é¿ç­–ç•¥**ï¼šæŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨ï¼ˆjitterï¼‰ï¼Œé¿å…â€œæƒŠç¾¤æ•ˆåº”â€ã€‚



## 5. æ‰§è¡Œæµç¨‹

### 5.1 å¯åŠ¨ï¼ˆ`start`ï¼‰

1. åˆå§‹åŒ– `ChainState`ï¼ˆçŠ¶æ€ â†’ `RUNNING`ï¼ŒåŠ è½½åˆå§‹å˜é‡ï¼‰
2. å‘å¸ƒ `ChainStartEvent`
3. **è°ƒåº¦æ‰€æœ‰å…¥å£èŠ‚ç‚¹**ï¼ˆ`definition.getStartNodes()`ï¼‰

### 5.2 èŠ‚ç‚¹æ‰§è¡Œï¼ˆ`executeNode`ï¼‰

1. æ£€æŸ¥æ¡ä»¶ `node.getCondition()`ï¼Œå†³å®šæ˜¯å¦è·³è¿‡
2. è°ƒç”¨ `node.execute(chain)`ï¼ˆå®é™…æ‰§è¡Œé€»è¾‘åœ¨ `Node` ä¸­ï¼‰
3. æ•è·å¼‚å¸¸ï¼Œè®°å½•é”™è¯¯
4. è°ƒç”¨ `handleNodeResult` å¤„ç†ç»“æœ

### 5.3 ç»“æœå¤„ç†ï¼ˆ`handleNodeResult`ï¼‰

#### æˆåŠŸè·¯å¾„ï¼š
- æ›´æ–° `NodeState` â†’ `SUCCEEDED`
- å°†è¾“å‡ºå†™å…¥ `ChainState.memory`ï¼ˆé”®ä¸º `nodeId.outputKey`ï¼‰
- è‹¥å¯ç”¨ `resetRetryCountAfterNormal`ï¼Œé‡ç½®é‡è¯•è®¡æ•°
- **è°ƒåº¦ä¸‹æ¸¸èŠ‚ç‚¹**ï¼ˆæˆ–å¾ªç¯/æŒ‚èµ·ï¼‰

#### å¤±è´¥è·¯å¾„ï¼š
- æ›´æ–° `NodeState` â†’ `ERROR`
- è‹¥å¯ç”¨é‡è¯•ä¸”æœªè¾¾ä¸Šé™ â†’ **å»¶è¿Ÿé‡è¯•**
- å¦åˆ™ â†’ é“¾ç»ˆæ­¢ï¼ˆ`ChainStatus.FAILED`ï¼‰

#### æŒ‚èµ·è·¯å¾„ï¼š
- æŠ›å‡º `ChainSuspendException`
- æ›´æ–°çŠ¶æ€ â†’ `SUSPEND`
- è®°å½•éœ€å¤–éƒ¨æä¾›çš„å‚æ•°ï¼ˆ`suspendForParameters`ï¼‰

### 5.4 èŠ‚ç‚¹è°ƒåº¦ï¼ˆ`scheduleNode`ï¼‰

- ç”Ÿæˆ `Trigger` å¯¹è±¡ï¼ˆå« `stateInstanceId`ã€`nodeId`ã€`edgeId`ã€`delayMs` ç­‰ï¼‰
- äº¤ç”± `TriggerScheduler` å¼‚æ­¥è°ƒåº¦
- **æ”¯æŒ**ï¼š
    - æ™®é€šæ‰§è¡Œï¼ˆ`TriggerType.NEXT`ï¼‰
    - é‡è¯•ï¼ˆ`RETRY`ï¼‰
    - å¾ªç¯ï¼ˆ`LOOP`ï¼‰
    - æ‰‹åŠ¨æ¢å¤ï¼ˆ`MANUAL`ï¼‰



## 6. é«˜çº§ç‰¹æ€§

### 6.1 å¾ªç¯ï¼ˆLoopï¼‰

```java
if (node.isLoopEnable()) {
    // æ£€æŸ¥ï¼šæ˜¯å¦è¶…æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼Ÿ
    // æ£€æŸ¥ï¼šæ˜¯å¦æ»¡è¶³ breakConditionï¼Ÿ
    // å¦åˆ™ï¼šloopCount++ï¼Œé‡æ–°è°ƒåº¦è‡ªèº«
}
```

- é€šè¿‡ `loopIntervalMs` æ§åˆ¶å¾ªç¯é—´éš”
- é€šè¿‡ `loopBreakCondition` åŠ¨æ€é€€å‡º

### 6.2 æ¡ä»¶åˆ†æ”¯ï¼ˆConditional Edgesï¼‰

- **èŠ‚ç‚¹çº§æ¡ä»¶**ï¼š`node.getCondition()` å†³å®šèŠ‚ç‚¹æ˜¯å¦æ‰§è¡Œ
- **è¾¹çº§æ¡ä»¶**ï¼š`edge.getCondition()` å†³å®šæ˜¯å¦èµ°å‘ä¸‹æ¸¸èŠ‚ç‚¹

> æ¡ä»¶å®ç°éœ€å®ç° `NodeCondition` / `EdgeCondition` æ¥å£ï¼Œå¯è®¿é—® `ChainState`ã€`NodeState`ã€ä¸Šä¸€èŠ‚ç‚¹è¾“å‡ºç­‰ã€‚

### 6.3 æŒ‚èµ·ä¸æ¢å¤ï¼ˆSuspend & Resumeï¼‰

#### æŒ‚èµ·ï¼š
```java
throw new ChainSuspendException(Map.of("requiredParam", "description"));
```

#### æ¢å¤ï¼š
```java
chain.resume(Map.of("requiredParam", "value"));
// è‡ªåŠ¨è°ƒåº¦æ‰€æœ‰ suspendNodeIds
```

> é€‚ç”¨äºäººæœºåä½œã€å¼‚æ­¥å®¡æ‰¹ã€å¤–éƒ¨ç³»ç»Ÿå›è°ƒç­‰åœºæ™¯ã€‚

### 6.4 ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼ˆThreadLocalï¼‰

```java
public static Chain currentChain() {
    return EXECUTION_THREAD_LOCAL.get();
}
```

- åœ¨ `Node.execute()` ä¸­å¯éšæ—¶è·å–å½“å‰ `Chain` å®ä¾‹
- ä¾¿äºæ—¥å¿—è¿½è¸ªï¼ˆMDCï¼‰ã€é“¾è·¯ä¼ é€’



## 7. æ‰©å±•ç‚¹

### 7.1 è‡ªå®šä¹‰çŠ¶æ€å­˜å‚¨

å®ç° `ChainStateRepository` / `NodeStateRepository`ï¼š
- ä½¿ç”¨æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLï¼‰
- ä½¿ç”¨å†…å­˜ï¼ˆ`InMemoryChainStateRepository`ï¼Œç”¨äºæµ‹è¯•ï¼‰
- ä½¿ç”¨ Redisï¼ˆæ”¯æŒ TTLã€åˆ†å¸ƒå¼é”ï¼‰

### 7.2 è‡ªå®šä¹‰è°ƒåº¦å™¨

å®ç° `TriggerScheduler`ï¼š
- åŸºäºçº¿ç¨‹æ± ï¼ˆ`ExecutorTriggerScheduler`ï¼‰
- åŸºäºæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQã€Kafkaï¼‰
- åŸºäºåˆ†å¸ƒå¼è°ƒåº¦ï¼ˆQuartz Clusterï¼‰

### 7.3 äº‹ä»¶ç›‘å¬

æ³¨å†Œ `EventListener` åˆ° `EventManager`ï¼š
```java
eventManager.addEventListener(ChainEndEvent.class, event -> {
    // å‘é€é€šçŸ¥ã€è®°å½•å®¡è®¡æ—¥å¿—ç­‰
});
```





## 8. æ€§èƒ½ä¸å¯é æ€§

| æœºåˆ¶ | è¯´æ˜        |
|--|-----------|
| **ä¹è§‚é”** | é¿å…åˆ†å¸ƒå¼å†™å†²çª  |
| **æŒ‡æ•°é€€é¿** | é™ä½é‡è¯•é£æš´é£é™©  |
| **å­—æ®µçº§æ›´æ–°** | å‡å°‘ I/O å¼€é”€ |
| **å¼‚æ­¥è°ƒåº¦** | è§£è€¦æ‰§è¡Œä¸è°ƒåº¦   |
| **çŠ¶æ€å¿«ç…§** | æ”¯æŒæŒä¹…åŒ–ä¸æ¢å¤  |

> ğŸ’¡ **ç”Ÿäº§å»ºè®®**ï¼šæ­é… Redis å®ç° `ChainStateRepository` + `TriggerScheduler`ï¼Œè·å¾—é«˜æ€§èƒ½ä¸é«˜å¯ç”¨ã€‚



## 9. æ€»ç»“

`Chain` ä¸ä»…æ˜¯ä¸€ä¸ªå·¥ä½œæµæ‰§è¡Œå™¨ï¼Œæ›´æ˜¯ä¸€ä¸ª**é¢å‘ AI åº”ç”¨çš„è¿è¡Œæ—¶å¼•æ“**ã€‚å®ƒé€šè¿‡**çŠ¶æ€ç®¡ç†ã€äº‹ä»¶é©±åŠ¨ã€ä¹è§‚å¹¶å‘ã€å¯æ¢å¤æ‰§è¡Œ**ç­‰æœºåˆ¶ï¼Œè§£å†³äº† AI å·¥ä½œæµä¸­å¸¸è§çš„**é•¿æ—¶è¿è¡Œã€å¼‚æ­¥äº¤äº’ã€é”™è¯¯æ¢å¤ã€å¯è§‚æµ‹æ€§**ç­‰éš¾é¢˜ã€‚

å¼€å‘è€…å¯é€šè¿‡æ‰©å±•å…¶ç»„ä»¶ï¼Œè½»æ¾æ„å»ºä¼ä¸šçº§ AI Agentã€è‡ªåŠ¨åŒ–å·¥ä½œæµã€æ™ºèƒ½å®¢æœç­‰å¤æ‚ç³»ç»Ÿã€‚
